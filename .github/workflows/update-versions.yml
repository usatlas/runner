name: Update Runner Versions

on:
  schedule:
    - cron: "0 6 * * *" # daily 06:00 UTC
  workflow_dispatch:

# Configuration for version tracking - add new components here
env:
  VERSION_VARS:
    '("RUNNER_VERSION" "RUNNER_CONTAINER_HOOKS_VERSION" "DOCKER_VERSION"
    "BUILDX_VERSION")'
  REPOS:
    '("actions/runner" "actions/runner-container-hooks" "moby/moby"
    "docker/buildx")'
  FRIENDLY_NAMES: '("Runner" "Container Hooks" "Docker" "Buildx")'

jobs:
  update-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Load current versions
        id: versions
        uses: falti/dotenv-action@v1.1.4
        with:
          log-variables: true
          export-variables: true
          keys-case: "upper"

      - name: Fetch latest releases
        id: fetch_latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Load configuration from top-level env
          eval "VERSION_VARS=${{ env.VERSION_VARS }}"
          eval "REPOS=${{ env.REPOS }}"

          # Fetch latest version for each repo
          for i in "${!VERSION_VARS[@]}"; do
            VAR="${VERSION_VARS[$i]}"
            REPO="${REPOS[$i]}"
            LATEST=$(gh api repos/$REPO/releases -q '.[0].tag_name' | tr -d 'v')
            echo "LATEST_$VAR=$LATEST" >> $GITHUB_ENV
            echo "Fetched $VAR: $LATEST from $REPO"
          done

      - name: Update .env if needed
        id: update
        run: |
          # Load configuration from top-level env
          eval "VERSION_VARS=${{ env.VERSION_VARS }}"

          UPDATED=false

          # Update .env for each changed version
          for VAR in "${VERSION_VARS[@]}"; do
            CURRENT="${!VAR}"
            LATEST_VAR="LATEST_$VAR"
            LATEST="${!LATEST_VAR}"

            if [ "$CURRENT" != "$LATEST" ]; then
              echo "Updating $VAR: $CURRENT → $LATEST"
              sed -i "s/^$VAR=.*/$VAR=$LATEST/" .env
              UPDATED=true
            fi
          done

          echo "UPDATED=$UPDATED" >> $GITHUB_OUTPUT

      - name: Show changes
        if: steps.update.outputs.UPDATED == 'true'
        run: git diff --color=always

      - name: Create or update PR if versions changed
        if: steps.update.outputs.UPDATED == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          # Load configuration from top-level env
          eval "VERSION_VARS=${{ env.VERSION_VARS }}"
          eval "REPOS=${{ env.REPOS }}"
          eval "FRIENDLY_NAMES=${{ env.FRIENDLY_NAMES }}"

          BRANCH=update-runner-versions
          git checkout -B $BRANCH

          COMMIT_MSG="Update component versions"
          MSG_LINES=()

          # Build message lines for changed versions
          for i in "${!VERSION_VARS[@]}"; do
            VAR="${VERSION_VARS[$i]}"
            REPO="${REPOS[$i]}"
            FRIENDLY="${FRIENDLY_NAMES[$i]}"

            CURRENT="${!VAR}"
            LATEST_VAR="LATEST_$VAR"
            LATEST="${!LATEST_VAR}"

            if [ "$CURRENT" != "$LATEST" ]; then
              MSG_LINES+=("- $FRIENDLY: [$CURRENT](https://github.com/$REPO/releases/tag/v$CURRENT) → [$LATEST](https://github.com/$REPO/releases/tag/v$LATEST)")
            fi
          done

          if [ ${#MSG_LINES[@]} -gt 0 ]; then
            COMMIT_MSG=$(printf "Update component versions\n\n%s" "$(printf "%s\n" "${MSG_LINES[@]}")")
          fi

          git add .env
          git commit -m "$COMMIT_MSG"
          git push --set-upstream origin $BRANCH --force

          # Check if a PR already exists
          EXISTING_PR=$(gh pr list --head $BRANCH --json number -q '.[0].number')
          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --title "Update component versions" \
              --body "$COMMIT_MSG" \
              --base main \
              --head $BRANCH
          else
            echo "PR already exists: #$EXISTING_PR"
          fi
